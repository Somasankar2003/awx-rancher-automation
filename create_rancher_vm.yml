---
- name: Create OpenStack VMs and register to Rancher RKE2 cluster (FINAL FIX)
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    ###########################################################################
    # RANCHER DETAILS
    ###########################################################################
    rancher_url: "https://192.168.210.32"
    rancher_token: "token-kt4rg:zppllkvsr7xl5cndlb4n4njqbckzjsmkd557xbgmh69bzdc7kqrkbl"
    cluster_name: "{{ cluster_name }}"
    ca_checksum: "314fb475a79f038ea12ebc2be48956716027ceebf9dd5ea11d7dce85bb2b20c7"

    ###########################################################################
    # SURVEY INPUTS
    ###########################################################################
    vm_count: "{{ vm_count | int }}"
    node_roles: "{{ node_roles }}"
    vm_name_prefix: "{{ vm_name_prefix }}"
    vm_net: "{{ vm_net }}"
    vm_flavor: "{{ vm_flavor }}"

    ###########################################################################
    # VM DETAILS
    ###########################################################################
    vm_image: "494c4e8c-d11b-43b7-9e8b-df4009b7102b"
    vm_keypair: "k8s"

    ###########################################################################
    # OPENSTACK AUTH
    ###########################################################################
    os_auth_url: "http://192.168.170.50:5000"
    os_project_name: "Production Engineering"
    os_project_domain_id: "default"
    os_username: "admin"
    os_user_domain_name: "Default"
    os_password: "bLEZFvatBShkvUZyKrasUjmNdTTc9c3HcxWykrro"
    os_region_name: "RegionOne"
    os_interface: "public"
    os_identity_api_version: "3"

  tasks:

    ###########################################################################
    # VM NAME GENERATION
    ###########################################################################
    - name: Generate VM names
      set_fact:
        vm_names_list: >-
          {% if ',' in vm_name_prefix %}
            {{ vm_name_prefix.split(',') }}
          {% else %}
            {{ range(1, vm_count + 1)
               | map('string')
               | map('regex_replace', '^(.*)$', vm_name_prefix ~ '\\1')
               | list }}
          {% endif %}

    ###########################################################################
    # ROLE NORMALIZATION (CRITICAL FIX)
    ###########################################################################
    - name: Normalize roles (support 1 VM or many)
      set_fact:
        parsed_roles: >-
          {% if vm_count == 1 %}
            [ "{{ node_roles }}" ]
          {% else %}
            {{ node_roles.split(',') | map('trim') | list }}
          {% endif %}

    - name: Debug parsed input
      debug:
        msg:
          - "VM Count: {{ vm_count }}"
          - "VM Names: {{ vm_names_list }}"
          - "Roles: {{ parsed_roles }}"

    - name: Validate inputs
      assert:
        that:
          - vm_names_list | length == vm_count
          - parsed_roles | length == vm_count
        fail_msg: "VM count, names, and roles mismatch"

    ###########################################################################
    # GET RANCHER CLUSTER
    ###########################################################################
    - name: Get Rancher cluster
      uri:
        url: "{{ rancher_url }}/v3/clusters?name={{ cluster_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: no
      register: cluster_info

    - name: Fail if cluster not found
      fail:
        msg: "Cluster {{ cluster_name }} not found in Rancher"
      when: cluster_info.json.data | length == 0

    - set_fact:
        cluster_id: "{{ cluster_info.json.data[0].id }}"

    ###########################################################################
    # GET SYSTEM AGENT TOKEN
    ###########################################################################
    - name: Fetch registration token
      uri:
        url: "{{ rancher_url }}/v3/clusterregistrationtokens?clusterId={{ cluster_id }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: no
      register: token_info

    - set_fact:
        join_token: "{{ token_info.json.data[0].token }}"

    ###########################################################################
    # CREATE VMS WITH SYSTEM-AGENT (CORRECT WAY)
    ###########################################################################
    - name: Create OpenStack VMs
      openstack.cloud.server:
        state: present
        name: "{{ item.0 }}"
        image: "{{ vm_image }}"
        flavor: "{{ vm_flavor }}"
        key_name: "{{ vm_keypair }}"
        network: "{{ vm_net }}"
        auto_ip: yes
        wait: yes
        timeout: 600
        config_drive: yes
        userdata: |
          #cloud-config
          package_update: true
          packages:
            - curl
            - nfs-common

          runcmd:
            - swapoff -a
            - sed -i '/swap/d' /etc/fstab

            - |
              ROLES=""
              {% if 'etcd' in item.1 %}ROLES="$ROLES --etcd"{% endif %}
              {% if 'controlplane' in item.1 %}ROLES="$ROLES --controlplane"{% endif %}
              {% if 'worker' in item.1 %}ROLES="$ROLES --worker"{% endif %}

              curl --insecure -fL {{ rancher_url }}/system-agent-install.sh | \
              sh -s - \
                --server {{ rancher_url }} \
                --token {{ join_token }} \
                --ca-checksum {{ ca_checksum }} \
                --node-name {{ item.0 }} \
                $ROLES
      environment:
        OS_AUTH_URL: "{{ os_auth_url }}"
        OS_PROJECT_NAME: "{{ os_project_name }}"
        OS_PROJECT_DOMAIN_ID: "{{ os_project_domain_id }}"
        OS_USERNAME: "{{ os_username }}"
        OS_USER_DOMAIN_NAME: "{{ os_user_domain_name }}"
        OS_PASSWORD: "{{ os_password }}"
        OS_REGION_NAME: "{{ os_region_name }}"
        OS_INTERFACE: "{{ os_interface }}"
        OS_IDENTITY_API_VERSION: "{{ os_identity_api_version }}"
      loop: "{{ vm_names_list | zip(parsed_roles) | list }}"

    ###########################################################################
    # WAIT FOR NODES
    ###########################################################################
    - name: Wait for nodes to register
      uri:
        url: "{{ rancher_url }}/v3/nodes?clusterId={{ cluster_id }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: no
      register: rancher_nodes
      until: rancher_nodes.json.data | length >= vm_count
      retries: 60
      delay: 15

    ###########################################################################
    # WAIT FOR CLUSTER ACTIVE
    ###########################################################################
    - name: Wait for cluster ACTIVE
      uri:
        url: "{{ rancher_url }}/v3/clusters/{{ cluster_id }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: no
      register: cluster_state
      until: cluster_state.json.state == "active"
      retries: 60
      delay: 20

    ###########################################################################
    # SUCCESS
    ###########################################################################
    - name: SUCCESS
      debug:
        msg: |
          âœ… CLUSTER ACTIVE
          Cluster: {{ cluster_name }}
          Nodes: {{ rancher_nodes.json.data | length }}
